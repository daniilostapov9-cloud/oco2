<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ú–æ–¥–Ω—ã–π –ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background:#0a0a0a; color:#fff; }
    .gradient-bg{background:linear-gradient(180deg,#184b32 0%,#0f1b15 55%,#0a0a0a 100%);opacity:.9}
    .cal-hero{position:relative; isolation:isolate; border-radius:20px; overflow:hidden;
      background:linear-gradient(180deg,rgba(31,95,62,.35),rgba(31,95,62,.15),rgba(0,0,0,.35));
      box-shadow: 0 10px 30px rgba(0,0,0,.4); }
    .cal-hero::before{content:""; position:absolute; inset:0;
      background:var(--bg, linear-gradient(180deg,#0f1b15,#0a0f0c)); background-size:cover; background-position:center;
      z-index:-1; opacity:.9; }
    .cal-month{ font-family: 'Times New Roman', Georgia, serif; letter-spacing:.02em; text-transform: uppercase; color:#d7efdf; }
    .cal-year{ font-weight:900; font-size:2.5rem; line-height:1; color:#ffffff; text-shadow:0 5px 25px rgba(0,0,0,.45); }
    .wd{ padding:.4rem .6rem; border-radius:10px; border:1px solid rgba(255,255,255,.08);
         background: rgba(255,255,255,.06); color:#e8f3ed; }
    .grid7{ display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem; }
    .day{ aspect-ratio:1/1; border-radius:12px; display:flex; align-items:center; justify-content:center;
          position:relative; font-weight:700;
          background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
          border:1px solid rgba(255,255,255,.07); box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
          transition: transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease; }
    .day .num{ color:#f4fff8; }
    .day.other .num{ color:#ffffffc0; }
    .day:hover{ transform: translateY(-1px); box-shadow: 0 8px 24px rgba(22, 163, 74, .15); }
    .day.disabled{ opacity:.35; pointer-events:none; }
    .day.sunday .num{ color:#ff7a7a; }
    .day.tomorrow{ background:linear-gradient(180deg, rgba(76,175,115,.25), rgba(35,94,62,.2));
                   border-color: rgba(76,175,115,.45);
                   box-shadow: 0 8px 26px rgba(35, 94, 62, .35), inset 0 1px 0 rgba(255,255,255,.1); }
    .day.tomorrow::after{ content:""; position:absolute; inset:-2px; border-radius:14px;
                          box-shadow: 0 0 0 2px rgba(76,175,115,.45) inset; pointer-events:none; }
    .day.done{ opacity:.45; }
    .day.done::before{ content:"‚úì"; position:absolute; right:6px; top:6px; font-size:.8rem; color:#b6e7c9; text-shadow:0 1px 0 rgba(0,0,0,.4); }
    .chip{padding:.5rem .75rem;border-radius:999px;background:#1f2937;cursor:pointer}
    .chip.active{background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%)}
    .ok-btn{background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%); box-shadow:0 4px 20px rgba(124,58,237,.4)}
  </style>
</head>
<body class="min-h-screen">
  <div class="gradient-bg fixed top-0 left-0 right-0 h-[220px]"></div>

  <div class="relative z-10 max-w-[680px] mx-auto px-5 pb-16">
    <header class="pt-6">
      <div class="flex items-center justify-between">
        <a href="/" class="text-white/70 text-sm hover:text-white">‚Üê –ù–∞–∑–∞–¥</a>
        <h1 class="text-xl font-bold">‚ú® –ú–æ–¥–Ω—ã–π –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
        <div class="w-10"></div>
      </div>
      <div id="auth-hint" class="mt-3 text-sm text-amber-300 hidden"></div>
    </header>

    <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
    <section class="cal-hero mt-6 p-5" id="calRoot" style="--bg:url('/img/leaf.jpg')">
      <div class="flex items-end justify-between mb-2">
        <div class="cal-year" id="yearLabel"></div>
      </div>

      <div class="flex items-center justify-between mb-2">
        <h2 class="cal-month text-3xl font-semibold" id="monthLabel"></h2>
        <div class="text-white/80 text-sm" id="todayLabel"></div>
      </div>

      <div class="grid7 text-xs mb-2">
        <div class="wd text-center">–ü–ù</div>
        <div class="wd text-center">–í–¢</div>
        <div class="wd text-center">–°–†</div>
        <div class="wd text-center">–ß–¢</div>
        <div class="wd text-center">–ü–¢</div>
        <div class="wd text-center">–°–ë</div>
        <div class="wd text-center">–í–°</div>
      </div>

      <div id="calGrid" class="grid7"></div>
      <p class="text-xs text-white/70 mt-3">–ê–∫—Ç–∏–≤–µ–Ω —Ç–æ–ª—å–∫–æ <b>–∑–∞–≤—Ç—Ä–∞—à–Ω–∏–π</b> –¥–µ–Ω—å. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è ‚úì.</p>
    </section>

    <!-- –í–´–ë–û–† –ù–ê–°–¢–†–û–ï–ù–ò–Ø/–ü–û–õ–ê -->
    <section id="picker" class="mt-6 bg-[#141414] rounded-2xl p-4 shadow-xl hidden">
      <h3 class="font-semibold mb-3">–ö–∞–∫–æ–µ —É —Ç–µ–±—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞?</h3>
      <div id="moods" class="flex flex-wrap gap-2"></div>

      <h3 class="font-semibold mt-5 mb-3">–í—ã–±–µ—Ä–∏ –ø–æ–ª</h3>
      <div id="genders" class="flex gap-2">
        <button data-gender="–ø–∞—Ä–µ–Ω—å" class="chip">–ü–∞—Ä–µ–Ω—å</button>
        <button data-gender="–¥–µ–≤—É—à–∫–∞" class="chip">–î–µ–≤—É—à–∫–∞</button>
      </div>

      <button id="genBtn" class="ok-btn mt-5 w-full py-3 rounded-xl font-semibold disabled opacity-50" disabled>
        –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑
      </button>
      <div id="genNote" class="text-xs text-white/50 mt-2">
        –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω ‚úì, –∞ –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∑–∞–≤—Ç—Ä–∞.
      </div>
    </section>

    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
    <section id="resultCard" class="mt-6 bg-[#141414] rounded-2xl p-4 shadow-xl hidden">
      <div class="flex gap-3 items-start">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center"
             style="background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%);">üëó</div>
        <div class="flex-1">
          <h3 class="font-semibold mb-2">–û–±—Ä–∞–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞</h3>
          <div id="outfitText" class="text-white/80 text-sm leading-relaxed whitespace-pre-line"></div>
          <button id="confirmBtn" class="ok-btn mt-4 w-full py-3 rounded-xl font-semibold">–û–∫–µ–π</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== auth cookies (optional hint)
    function getCookie(name){
      return document.cookie.split('; ').find(r => r.startsWith(name + '='))?.split('=')[1];
    }
    const vkToken = getCookie('vk_id_token');
    const vkUserId = getCookie('vk_user_id');
    if (!vkToken || !vkUserId) {
      const hint = document.getElementById('auth-hint');
      hint.classList.remove('hidden');
      hint.textContent = '–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –û–°–û, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º.';
    }

    // ===== dates
    const tz = 'Europe/Zurich';
    const fmtMonth = (d) => new Intl.DateTimeFormat('ru-RU',{ timeZone:tz, month:'long'}).format(d).toUpperCase();
    const fmtYear = (d) => new Intl.DateTimeFormat('ru-RU',{ timeZone:tz, year:'numeric'}).format(d);
    const fmtToday = (d) => new Intl.DateTimeFormat('ru-RU',{ timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit'}).format(d);
    const ymd = (d) => new Intl.DateTimeFormat('en-CA',{ timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit'}).format(d);

    const now = new Date();
    const tomorrow = new Date(); tomorrow.setDate(now.getDate()+1);
    const tomorrowYMD = ymd(tomorrow);

    // ===== mood chips
    const MOODS = ['—Ä–∞–¥–æ—Å—Ç–Ω–æ–µ','–≥—Ä—É—Å—Ç–Ω–æ–µ','—Ç—Ä–µ–≤–æ–∂–Ω–æ–µ','—Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ–µ','–≤–∏–Ω–æ–≤–∞—Ç–æ–µ','—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ–µ','–≤–æ–∑–±—É–∂–¥–µ–Ω–Ω–æ–µ','—Å–∫—É—á–Ω–æ–µ','—Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ'];
    const moodsWrap = document.getElementById('moods');
    let pickedMood = null, pickedGender = null, pickedDate = null, generatedOutfit = null;
    MOODS.forEach(m => {
      const b = document.createElement('button');
      b.className = 'chip';
      b.textContent = m.charAt(0).toUpperCase() + m.slice(1);
      b.onclick = () => { [...moodsWrap.children].forEach(c=>c.classList.remove('active')); b.classList.add('active'); pickedMood=m; maybeEnableGen(); };
      moodsWrap.appendChild(b);
    });
    document.querySelectorAll('#genders .chip').forEach(btn => {
      btn.onclick = () => { document.querySelectorAll('#genders .chip').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); pickedGender=btn.dataset.gender; maybeEnableGen(); }
    });
    function maybeEnableGen(){
      const genBtn = document.getElementById('genBtn');
      if (pickedMood && pickedGender && pickedDate === tomorrowYMD) { genBtn.disabled=false; genBtn.classList.remove('disabled','opacity-50'); }
      else { genBtn.disabled=true; genBtn.classList.add('disabled','opacity-50'); }
    }

    // ===== DB completed
    let completed = {};
    async function fetchCompleted(year, month){
      try{
        const r = await fetch(`/api/calendar-get?year=${year}&month=${month}`, { credentials:'include' });
        if(r.ok){
          (await r.json()).entries.forEach(e=> completed[e.date]=true);
        }
      }catch(e){}
    }

    // ===== build grid with prev/next month numbers (disabled), dynamic to 6 rows (42 cells)
    async function renderCalendar(){
      const calGrid = document.getElementById('calGrid');
      const monthLabel = document.getElementById('monthLabel');
      const yearLabel = document.getElementById('yearLabel');
      const todayLabel = document.getElementById('todayLabel');

      const local = new Date(new Intl.DateTimeFormat('en-CA',{timeZone:tz}).format(now)+'T00:00:00Z');
      const year = local.getUTCFullYear();
      const month = local.getUTCMonth(); // 0..11
      await fetchCompleted(year, month+1);

      monthLabel.textContent = fmtMonth(now);
      yearLabel.textContent = fmtYear(now);
      todayLabel.textContent = '–°–µ–≥–æ–¥–Ω—è: ' + fmtToday(now);

      calGrid.innerHTML = '';

      const first = new Date(Date.UTC(year, month, 1));
      let weekday = first.getUTCDay(); if (weekday===0) weekday=7; // Mon=1..Sun=7
      const daysInMonth = new Date(year, month+1, 0).getUTCDate();
      const daysInPrev = new Date(year, month, 0).getUTCDate();

      // leading from prev month
      const lead = weekday-1;
      for (let i=lead-1; i>=0; i--){
        const num = daysInPrev - i;
        const cell = document.createElement('button');
        cell.className = 'day other disabled';
        cell.disabled = true;
        cell.innerHTML = `<span class="num">${num}</span>`;
        calGrid.appendChild(cell);
      }

      // current month days
      for (let d=1; d<=daysInMonth; d++){
        const date = new Date(Date.UTC(year, month, d));
        const dateYMD = ymd(date);
        const cell = document.createElement('button');
        cell.className = 'day';
        cell.innerHTML = `<span class="num">${d}</span>`;

        let w = date.getUTCDay(); if (w===0) w=7;
        if (w===7) cell.classList.add('sunday');

        const isTomorrow = dateYMD === tomorrowYMD;
        if (completed[dateYMD]) {
          cell.classList.add('done','disabled'); cell.disabled = true;
        } else if (isTomorrow) {
          cell.classList.add('tomorrow');
        } else {
          cell.classList.add('disabled'); cell.disabled = true;
        }
        if (isTomorrow && !completed[dateYMD]) {
          cell.addEventListener('click', () => {
            pickedDate = dateYMD;
            document.getElementById('picker').classList.remove('hidden');
            maybeEnableGen();
            cell.focus();
          });
        }
        calGrid.appendChild(cell);
      }

      // trailing for next month to fill to 42 cells
      const cellsNow = calGrid.children.length;
      const tail = (Math.ceil(cellsNow/7)*7 === cellsNow) ? 0 : (Math.ceil(cellsNow/7)*7 - cellsNow);
      const nextNeeded = (cellsNow + tail < 42) ? 42 - cellsNow : tail;
      for (let i=1; i<=nextNeeded; i++){
        const cell = document.createElement('button');
        cell.className = 'day other disabled'; cell.disabled = true;
        cell.innerHTML = `<span class="num">${i}</span>`;
        calGrid.appendChild(cell);
      }
    }

    // ===== generate outfit
    const genBtn = document.getElementById('genBtn');
    const resultCard = document.getElementById('resultCard');
    const outfitTextEl = document.getElementById('outfitText');
    const confirmBtn = document.getElementById('confirmBtn');
    genBtn.addEventListener('click', async () => {
      genBtn.disabled = true; genBtn.textContent = '–ü–æ–¥–±–∏—Ä–∞—é...';
      try {
        const r = await fetch('/api/generate-outfit', {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ date: pickedDate, mood: pickedMood, gender: pickedGender })
        });
        const data = await r.json(); if(!r.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
        generatedOutfit = data.outfit;
        outfitTextEl.textContent = generatedOutfit;
        resultCard.classList.remove('hidden');
        resultCard.scrollIntoView({ behavior:'smooth' });
      } catch(e){ alert(e.message); }
      finally { genBtn.textContent = '–ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑'; maybeEnableGen(); }
    });

    // ===== confirm & save
    confirmBtn.addEventListener('click', async () => {
      confirmBtn.disabled = true; confirmBtn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';
      try {
        const r = await fetch('/api/calendar-set', {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({ date: pickedDate, mood: pickedMood, gender: pickedGender, outfit: generatedOutfit })
        });
        const data = await r.json(); if(!r.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        alert('–ì–æ—Ç–æ–≤–æ! –î–µ–Ω—å –æ—Ç–º–µ—á–µ–Ω.');
        location.reload();
      } catch(e){ alert(e.message); }
      finally { confirmBtn.disabled = false; confirmBtn.textContent = '–û–∫–µ–π'; }
    });

    renderCalendar();
  </script>
</body>
</html>
