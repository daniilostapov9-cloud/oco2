<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale-1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ú–æ–¥–Ω—ã–π –ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background:#0a0a0a; color:#fff; }
    .gradient-bg{background:linear-gradient(180deg,#184b32 0%,#0f1b15 55%,#0a0a0a 100%);opacity:.9}
    .cal-hero{position:relative; isolation:isolate; border-radius:20px; overflow:hidden;
      background:linear-gradient(180deg,rgba(31,95,62,.35),rgba(31,95,62,.15),rgba(0,0,0,.35));
      box-shadow: 0 10px 30px rgba(0,0,0,.4); }
    .cal-hero::before{content:""; position:absolute; inset:0;
      background:var(--bg, linear-gradient(180deg,#0f1b15,#0a0f0c)); background-size:cover; background-position:center;
      z-index:-1; opacity:.9; }
    .cal-month{ font-family: 'Times New Roman', Georgia, serif; letter-spacing:.02em; text-transform: uppercase; color:#d7efdf; }
    .cal-year{ font-weight:900; font-size:2.5rem; line-height:1; color:#ffffff; text-shadow:0 5px 25px rgba(0,0,0,.45); }
    .wd{ padding:.4rem .6rem; border-radius:10px; border:1px solid rgba(255,255,255,.08);
         background: rgba(255,255,255,.06); color:#e8f3ed; }
    .grid7{ display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem; }
    .day{ aspect-ratio:1/1; border-radius:12px; display:flex; align-items:center; justify-content:center;
          position:relative; font-weight:700;
          background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
          border:1px solid rgba(255,255,255,.07); box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
          transition: transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease; }
    .day .num{ color:#f4fff8; }
    .day.other .num{ color:#ffffffc0; }
    .day:hover{ transform: translateY(-1px); box-shadow: 0 8px 24px rgba(22, 163, 74, .15); }
    .day.disabled{ opacity:.35; pointer-events:none; }
    .day.sunday .num{ color:#ff7a7a; }
    .day.today{ background:linear-gradient(180deg, rgba(76,175,115,.25), rgba(35,94,62,.2));
      border-color: rgba(76,175,115,.45);
      box-shadow: 0 8px 26px rgba(35, 94, 62, .35), inset 0 1px 0 rgba(255,255,255,.1); }
    .day.today::after{ content:""; position:absolute; inset:-2px; border-radius:14px;
      box-shadow: 0 0 0 2px rgba(76,175,115,.45) inset; pointer-events:none; }
    .day.done{ opacity:.45; }
    .day.done::before{ content:"‚úì"; position:absolute; right:6px; top:6px; font-size:.8rem; color:#b6e7c9; text-shadow:0 1px 0 rgba(0,0,0,.4); }
    .chip{padding:.5rem .75rem;border-radius:999px;background:#1f2937;cursor:pointer}
    .chip.active{background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%)}
    .ok-btn{background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%); box-shadow:0 4px 20px rgba(124,58,237,.4)}
    
    #outfitText strong { color: #fff; font-weight: 600; }
    #outfitText p { margin: 0; } 
    
    .ad-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:50}
    .ad-box{width:min(420px,92vw);min-height:280px;background:#111;border-radius:16px;padding:12px;position:relative}
    .ad-close{position:absolute;top:12px;right:16px;background:#222;border:0;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  </style>

  <script>
    (function(w,d,n,s,t){w[n]=w[n]||[];t=d.getElementsByTagName("script")[0];
      s=d.createElement("script");s.async=true;s.src="https://yandex.ru/ads/system/context.js";
      t.parentNode.insertBefore(s,t);
    })(window,document,"yandexContextAsyncCallbacks");
  </script>
</head>

<body class="min-h-screen">
  <div class="gradient-bg fixed top-0 left-0 right-0 h-[220px]"></div>

  <div id="ad-overlay" class="ad-overlay">
    <div class="ad-box">
      <button id="ad-close" class="ad-close">–ó–∞–∫—Ä—ã—Ç—å ‚úñ</button>
      <div id="ya-rtb-interstitial-calendar"></div>
    </div>
  </div>
  <div class="relative z-10 max-w-[680px] mx-auto px-5 pb-16">
    <header class="pt-6">
      <div class="flex items-center justify-between">
        <a href="/" class="text-white/70 text-sm hover:text-white">‚Üê –ù–∞–∑–∞–¥</a>
        <h1 class="text-xl font-bold">‚ú® –ú–æ–¥–Ω—ã–π –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
        <div class="w-10"></div>
      </div>
      <div id="auth-hint" class="mt-3 text-sm text-amber-300 hidden"></div>
    </header>

    <section class="cal-hero mt-6 p-5" id="calRoot" style="--bg:url('/img/leaf.jpg')">
      <div class="flex items-end justify-between mb-2"> <div class="cal-year" id="yearLabel"></div> </div>
      <div class="flex items-center justify-between mb-2"> <h2 class="cal-month text-3xl font-semibold" id="monthLabel"></h2> <div class="text-white/80 text-sm" id="todayLabel"></div> </div>
      <div class="grid7 text-xs mb-2"> <div class="wd text-center">–ü–ù</div><div class="wd text-center">–í–¢</div><div class="wd text-center">–°–†</div> <div class="wd text-center">–ß–¢</div><div class="wd text-center">–ü–¢</div><div class="wd text-center">–°–ë</div><div class="wd text-center">–í–°</div> </div>
      
      <div id="calGrid" class="grid7"></div>
      
      <p class="text-xs text-white/70 mt-3">–ê–∫—Ç–∏–≤–µ–Ω —Ç–æ–ª—å–∫–æ <b>—Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π</b> –¥–µ–Ω—å. –ù–∞–∂–º–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ check-in ‚úì.</p>
    </section>

    <section id="picker" class="mt-6 bg-[#141414] rounded-2xl p-4 shadow-xl hidden">
      <h3 class="font-semibold mb-3">–ö–∞–∫–æ–µ —É —Ç–µ–±—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ <b>—Å–µ–≥–æ–¥–Ω—è</b>?</h3>
      <div id="moods" class="flex flex-wrap gap-2"></div>
      <h3 class="font-semibold mt-5 mb-3">–í—ã–±–µ—Ä–∏ –ø–æ–ª</h3>
      <div id="genders" class="flex gap-2"> <button data-gender="–ø–∞—Ä–µ–Ω—å" class="chip">–ü–∞—Ä–µ–Ω—å</button> <button data-gender="–¥–µ–≤—É—à–∫–∞" class="chip">–î–µ–≤—É—à–∫–∞</button> </div>
      <button id="genBtn" class="ok-btn mt-5 w-full py-3 rounded-xl font-semibold disabled opacity-50" disabled> –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ </button>
      <div id="lockNote" class="text-xs text-emerald-300 mt-2 hidden"></div>
    </section>

    <section id="resultCard" class="mt-6 bg-[#141414] rounded-2xl p-4 shadow-xl hidden">
      <div class="flex gap-3 items-start">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%);">üëó</div>
        <div class="flex-1">
          <h3 class="font-semibold mb-2">–û–±—Ä–∞–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
          <div id="outfitText" class="text-white/80 text-sm leading-relaxed whitespace-pre-line"></div>
          <div id="previewWrap" class="mt-4 hidden">
            <button id="previewBtn" class="w-full py-2 rounded-xl font-semibold border border-white/10 hover:bg-white/5"> –ü–æ–∫–∞–∑–∞—Ç—å ¬´–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–∑–∞¬ª (–ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç) </button>
            <div id="previewImgBox" class="mt-3 hidden"> <img id="previewImg" class="w-full rounded-xl" alt="–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–∑–∞"> </div>
          </div>
          <button id="confirmBtn" class="ok-btn mt-4 w-full py-3 rounded-xl font-semibold">–û–∫–µ–π</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== auth cookies (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function getCookie(name){ return document.cookie.split('; ').find(r => r.startsWith(name + '='))?.split('=')[1]; }
    const vkToken = getCookie('vk_id_token'); const vkUserId = getCookie('vk_user_id');
    if (!vkToken || !vkUserId) { const hint = document.getElementById('auth-hint'); hint.classList.remove('hidden'); hint.textContent='–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –û–°–û.'; }

    // ===== dates (*** –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±—Ä–∞–ª–∏ –≤—Å—é –ª–æ–≥–∏–∫—É –æ—Ç—Å—é–¥–∞ ***)
    let todayYMD = null; // –≠—Ç—É "–ø—Ä–∞–≤–¥–∏–≤—É—é" –¥–∞—Ç—É –º—ã –ø–æ–ª—É—á–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞

    // ===== UI state (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    const MOODS=['—Ä–∞–¥–æ—Å—Ç–Ω–æ–µ','–≥—Ä—É—Å—Ç–Ω–æ–µ','—Ç—Ä–µ–≤–æ–∂–Ω–æ–µ','—Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ–µ','–≤–∏–Ω–æ–≤–∞—Ç–æ–µ','—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ–µ','–≤–æ–∑–±—É–∂–¥–µ–Ω–Ω–æ–µ','—Å–∫—É—á–Ω–æ–µ','—Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ'];
    const moodsWrap=document.getElementById('moods'); let pickedMood=null, pickedGender=null, pickedDate=null, generatedOutfit=null;
    MOODS.forEach(m=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=m.charAt(0).toUpperCase()+m.slice(1);
      b.onclick=()=>{[...moodsWrap.children].forEach(c=>c.classList.remove('active')); b.classList.add('active'); pickedMood=m; maybeEnableGen();}; moodsWrap.appendChild(b); });
    document.querySelectorAll('#genders .chip').forEach(btn=>{ btn.onclick=()=>{document.querySelectorAll('#genders .chip').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); pickedGender=btn.dataset.gender; maybeEnableGen();}; });

    function maybeEnableGen(){ 
      const g=document.getElementById('genBtn'); 
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ 'todayYMD' —Å —Å–µ—Ä–≤–µ—Ä–∞
      if(pickedMood&&pickedGender&&pickedDate===todayYMD){ 
        g.disabled=false; g.classList.remove('disabled','opacity-50'); 
      } else { 
        g.disabled=true; g.classList.add('disabled','opacity-50'); 
      } 
    }

    // ===== DB completed (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    let completed={};
    async function fetchCompleted(year,month){ try{ const r=await fetch(`/api/calendar-get?year=${year}&month=${month}`,{credentials:'include'}); if(r.ok){(await r.json()).entries.forEach(e=>completed[e.date]=e.confirmed);} }catch(e){} }

    // ===== build grid (*** –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ + –§–ò–ö–° –ë–ê–ì–ê –°–ï–¢–ö–ò ***)
    function renderCalendar(serverTime){
      const calGrid=document.getElementById('calGrid'); 
      const monthLabelEl=document.getElementById('monthLabel');
      const yearLabelEl=document.getElementById('yearLabel'); 
      const todayLabelEl=document.getElementById('todayLabel');

      // 1. –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
      const { year, month, monthLabel, yearLabel, todayLabel } = serverTime;

      monthLabelEl.textContent = monthLabel;
      yearLabelEl.textContent = yearLabel;
      todayLabelEl.textContent = todayLabel;

      calGrid.innerHTML='';

      // 2. *** –§–ò–ö–° –ë–ê–ì–ê –°–ï–¢–ö–ò ***
      // (year –∏ month - –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä 2025 –∏ 10 (–ù–æ—è–±—Ä—å))
      const first=new Date(Date.UTC(year,month,1)); 
      let weekday=first.getUTCDay(); if(weekday===0)weekday=7; // –ü–ù=1, –í–°=7
      
      const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate(); // (–ù–æ—è–±—Ä—å: 30)
      const daysInPrev=new Date(Date.UTC(year,month,0)).getUTCDate();   // (–û–∫—Ç—è–±—Ä—å: 31)

      // 3. *** –§–ò–ö–° –ë–ê–ì–ê –°–ï–¢–ö–ò *** (–î–Ω–∏ "–î–û")
      const lead = weekday - 1; // (–ï—Å–ª–∏ 1 –ù–æ—è = –°–ë (6), lead = 5)
      for(let i = 0; i < lead; i++){ 
        const num = daysInPrev - (lead - 1 - i); // (31 - (4-0) = 27 ... 31 - (4-4) = 31)
        const ph=document.createElement('button'); 
        ph.className='day other disabled'; ph.disabled=true; 
        ph.innerHTML=`<span class="num">${num}</span>`; 
        calGrid.appendChild(ph); 
      }

      // 4. –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      for(let d=1; d<=daysInMonth; d++){ 
        const date=new Date(Date.UTC(year,month,d));
        // –≠—Ç–∞ —É—Ç–∏–ª–∏—Ç–∞ –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å, —Ç–∞–∫ —á—Ç–æ –æ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è
        const ymd_local = (d_obj) => new Intl.DateTimeFormat('en-CA',{ timeZone:'UTC', year:'numeric', month:'2-digit', day:'2-digit'}).format(d_obj);
        const dateYMD = ymd_local(date);
        
        const cell=document.createElement('button'); cell.className='day'; cell.innerHTML=`<span class="num">${d}</span>`;
        let w=date.getUTCDay(); if(w===0)w=7; if(w===7)cell.classList.add('sunday');
        
        const isToday=(dateYMD===todayYMD); // todayYMD - "–ø—Ä–∞–≤–¥–∞" —Å —Å–µ—Ä–≤–µ—Ä–∞
        
        if(completed[dateYMD]){ cell.classList.add('done','disabled'); cell.disabled=true; }
        else if(isToday){ cell.classList.add('today'); }
        else { cell.classList.add('disabled'); cell.disabled=true; }
        
        if(isToday && !completed[dateYMD]){ 
          cell.addEventListener('click',()=>{ 
            pickedDate=dateYMD; 
            document.getElementById('picker').classList.remove('hidden'); 
            maybeEnableGen(); 
            cell.focus(); 
          }); 
        }
        calGrid.appendChild(cell);
      }
      
      // 5. *** –§–ò–ö–° –ë–ê–ì–ê –°–ï–¢–ö–ò *** (–î–Ω–∏ "–ü–û–°–õ–ï")
      const cellsNow=calGrid.children.length;
      const nextNeeded = 42 - cellsNow; // (–ü—Ä–æ—Å—Ç–æ –¥–æ–±–∏–≤–∞–µ–º –¥–æ 42)
      for(let i=1;i<=nextNeeded;i++){ 
        const ph=document.createElement('button'); 
        ph.className='day other disabled'; ph.disabled=true; 
        ph.innerHTML=`<span class="num">${i}</span>`; 
        calGrid.appendChild(ph); 
      }
    }

    // ===== DOM-—ç–ª–µ–º–µ–Ω—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    const genBtn=document.getElementById('genBtn'); const resultCard=document.getElementById('resultCard'); const outfitTextEl=document.getElementById('outfitText');
    const confirmBtn=document.getElementById('confirmBtn'); const lockNote=document.getElementById('lockNote');
    const previewWrap=document.getElementById('previewWrap'); const previewBtn=document.getElementById('previewBtn');
    const previewImgBox=document.getElementById('previewImgBox'); const previewImg=document.getElementById('previewImg');


    // ===== –†–µ–∫–ª–∞–º–∞ / –ì–µ–Ω–µ—Ä–∞—Ü–∏—è (–õ–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) =====
    
    async function runGenerateOutfit() {
      showInterstitialAd(async () => {
        genBtn.disabled = true; genBtn.textContent = '–ü–æ–¥–±–∏—Ä–∞—é...';
        lockNote.classList.add('hidden'); lockNote.textContent = '';
        try {
          const r = await fetch('/api/generate-outfit', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
            body: JSON.stringify({ date: pickedDate, mood: pickedMood, gender: pickedGender })
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
          
          generatedOutfit = data.outfit;
          outfitTextEl.innerHTML = marked.parse(generatedOutfit);
          
          resultCard.classList.remove('hidden'); resultCard.scrollIntoView({ behavior: 'smooth' });
          previewWrap.classList.remove('hidden');   
          if (data.locked_until_human) {              
            lockNote.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ ' + data.locked_until_human + '.';
            lockNote.classList.remove('hidden');
          }
        } catch (e) { alert(e.message); }
        finally { genBtn.textContent = '–ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑'; maybeEnableGen(); }
      });
    }

    async function runGenerateImage() {
      showInterstitialAd(async () => {
        previewBtn.disabled = true; previewBtn.textContent = '–†–∏—Å—É—é –ø—Ä–∏–º–µ—Ä...';
        try {
          const r = await fetch('/api/generate-outfit-image', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
            body: JSON.stringify({ date: pickedDate, outfit: generatedOutfit, gender: pickedGender })
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
          previewImg.src = 'data:image/png;base64,' + data.image_base64;
          previewImgBox.classList.remove('hidden');
        } catch (e) { alert(e.message); }
        finally { previewBtn.disabled = false; previewBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å ¬´–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–∑–∞¬ª (–ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç)'; }
      });
    }

    genBtn.addEventListener('click', () => {
      if (isWebView()) {
        window.location.href = '/trigger-gen-outfit';
      } else {
        runGenerateOutfit();
      }
    });

    previewBtn?.addEventListener('click', () => {
      if (isWebView()) {
        window.location.href = '/trigger-gen-image';
      } else {
        runGenerateImage();
      }
    });
    
    // ===== –ö–Ω–æ–ø–∫–∞ "–û–∫–µ–π" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) =====
    confirmBtn.addEventListener('click', async ()=>{
      confirmBtn.disabled=true; confirmBtn.textContent='–°–æ—Ö—Ä–∞–Ω—è—é...';
      try{
        const r=await fetch('/api/calendar-set',{ method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body:JSON.stringify({ date:pickedDate, mood:pickedMood, gender:pickedGender, outfit:generatedOutfit }) });
        const data=await r.json(); if(!r.ok) throw new Error(data.error||'–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        alert('–ì–æ—Ç–æ–≤–æ! –î–µ–Ω—å –æ—Ç–º–µ—á–µ–Ω.'); location.reload();
      }catch(e){ alert(e.message); }
      finally{ confirmBtn.disabled=false; confirmBtn.textContent='–û–∫–µ–π'; }
    });
    
    
    // ===== JS-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è WEB-—Ä–µ–∫–ª–∞–º—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) =====
    
    // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π ID –æ—Ç –Ø–Ω–¥–µ–∫—Å–∞
    const YANDEX_WEB_BLOCK_ID_CALENDAR = 'R-A-XXXXXXX-2'; // <-- –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô ID –ë–õ–û–ö–ê

    function isWebView(){
      const ua = navigator.userAgent || '';
      return /\bwv\b/i.test(ua);
    }
    
    function showInterstitialAd(onDone) {
      if (!YANDEX_WEB_BLOCK_ID_CALENDAR || YANDEX_WEB_BLOCK_ID_CALENDAR.includes('XXXXXX')) { 
        onDone(); 
        return; 
      }
      if (isWebView()) { 
        onDone(); 
        return; 
      } 

      const overlay = document.getElementById('ad-overlay');
      const closeBtn = document.getElementById('ad-close');
      if (!overlay || !closeBtn) { 
        onDone(); 
        return; 
      }

      let adClosed = false;
      const closeAd = () => {
        if (adClosed) return;
        adClosed = true;
        overlay.style.display = 'none';
        document.getElementById('ya-rtb-interstitial-calendar').innerHTML = '';
        onDone(); 
      };
      
      closeBtn.onclick = closeAd;
      overlay.style.display = 'flex';

      window.yandexContextAsyncCallbacks = window.yandexContextAsyncCallbacks || [];
      window.yandexContextAsyncCallbacks.push(() => {
        try {
          Ya.Context.AdvManager.render({
            blockId: YANDEX_WEB_BLOCK_ID_CALENDAR,
            renderTo: 'ya-rtb-interstitial-calendar',
            onClose: closeAd
          });
        } catch(e) { 
          console.warn('Yandex Ads error', e);
          closeAd();
        }
      });
    }

    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å—ë ---
    async function initializeCalendar() {
      try {
        // 1. –ü–æ–ª—É—á–∞–µ–º "–ø—Ä–∞–≤–¥–∏–≤–æ–µ" –≤—Ä–µ–º—è —Å —Å–µ—Ä–≤–µ—Ä–∞
        const response = await fetch('/api/get-time');
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è —Å —Å–µ—Ä–≤–µ—Ä–∞');
        const serverTime = await response.json();
        
        // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ì–õ–û–ë–ê–õ–¨–ù–£–Æ 'todayYMD'. –¢–µ–ø–µ—Ä—å —ç—Ç–æ "–ø—Ä–∞–≤–¥–∞".
        todayYMD = serverTime.todayYMD; 

        // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º "–≥–∞–ª–æ—á–∫–∏" –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞
        // (API calendar-get.js –∂–¥–µ—Ç –º–µ—Å—è—Ü 1-12, –∞ —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞–µ—Ç 0-11)
        await fetchCompleted(serverTime.year, serverTime.month + 1); 

        // 4. –¢–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –µ—Å—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, —Ä–∏—Å—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        renderCalendar(serverTime);
        
      } catch (e) {
        console.error(e);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        document.getElementById('calGrid').innerHTML = `<p class="text-red-400 p-4 col-span-7">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>`;
      }
    }

    // --- –ó–ê–ü–£–°–ö ---
    initializeCalendar();
    
  </script>
</body>
</html>
