<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ú–æ–¥–Ω—ã–π –ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background:#0a0a0a; color:#fff; }
    .chip{padding:.5rem .75rem;border-radius:999px;background:#1f2937;cursor:pointer}
    .chip.active{background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%)}
    .grid-day{aspect-ratio:1/1}
    .disabled{opacity:.35; pointer-events:none}
    .ok-btn{background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%); box-shadow:0 4px 20px rgba(124,58,237,.4)}
  </style>
</head>
<body class="min-h-screen">
  <div class="gradient-bg fixed top-0 left-0 right-0 h-[220px]"
       style="background:linear-gradient(180deg,#7c3aed 0%,#2563eb 50%,#0a0a0a 100%);opacity:.85"></div>

  <div class="relative z-10 max-w-[560px] mx-auto px-5 pb-16">
    <header class="pt-6">
      <div class="flex items-center justify-between">
        <a href="/" class="text-white/70 text-sm hover:text-white">‚Üê –ù–∞–∑–∞–¥</a>
        <h1 class="text-xl font-bold">‚ú® –ú–æ–¥–Ω—ã–π –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
        <div class="w-10"></div>
      </div>
      <p class="text-white/60 text-sm mt-1">–í—ã–±–∏—Ä–∞–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∞ <b>–∑–∞–≤—Ç—Ä–∞</b> ‚Äî –ø–æ–ª—É—á–∞–π –æ–±—Ä–∞–∑ –æ—Ç –ò–ò</p>
      <div id="auth-hint" class="mt-3 text-sm text-amber-300 hidden"></div>
    </header>

    <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
    <section class="mt-6 bg-[#141414] rounded-2xl p-4 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold" id="monthLabel"></div>
        <div class="text-white/50 text-sm" id="todayLabel"></div>
      </div>
      <div class="grid grid-cols-7 gap-2 text-white/50 text-xs mb-1">
        <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
      </div>
      <div id="daysGrid" class="grid grid-cols-7 gap-2"></div>
      <p class="text-xs text-white/50 mt-3">–î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å.</p>
    </section>

    <!-- –í–´–ë–û–† –ù–ê–°–¢–†–û–ï–ù–ò–Ø/–ü–û–õ–ê -->
    <section id="picker" class="mt-6 bg-[#141414] rounded-2xl p-4 shadow-xl hidden">
      <h3 class="font-semibold mb-3">–ö–∞–∫–æ–µ —É —Ç–µ–±—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞?</h3>
      <div id="moods" class="flex flex-wrap gap-2">
        <!-- chips -->
      </div>

      <h3 class="font-semibold mt-5 mb-3">–í—ã–±–µ—Ä–∏ –ø–æ–ª</h3>
      <div id="genders" class="flex gap-2">
        <button data-gender="–ø–∞—Ä–µ–Ω—å" class="chip">–ü–∞—Ä–µ–Ω—å</button>
        <button data-gender="–¥–µ–≤—É—à–∫–∞" class="chip">–î–µ–≤—É—à–∫–∞</button>
      </div>

      <button id="genBtn" class="ok-btn mt-5 w-full py-3 rounded-xl font-semibold disabled opacity-50" disabled>
        –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑
      </button>
      <div id="genNote" class="text-xs text-white/50 mt-2">
        –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω ‚úì, –∞ –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∑–∞–≤—Ç—Ä–∞.
      </div>
    </section>

    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
    <section id="resultCard" class="mt-6 bg-[#141414] rounded-2xl p-4 shadow-xl hidden">
      <div class="flex gap-3 items-start">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center"
             style="background:linear-gradient(135deg,#7c3aed 0%,#2563eb 100%);">üëó</div>
        <div class="flex-1">
          <h3 class="font-semibold mb-2">–û–±—Ä–∞–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞</h3>
          <div id="outfitText" class="text-white/80 text-sm leading-relaxed whitespace-pre-line"></div>
          <button id="confirmBtn" class="ok-btn mt-4 w-full py-3 rounded-xl font-semibold">–û–∫–µ–π</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ========== auth (–∫—É–∫–∏ –∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ) ==========
    function getCookie(name){
      return document.cookie.split('; ').find(r => r.startsWith(name + '='))?.split('=')[1];
    }
    const vkToken = getCookie('vk_id_token');
    const vkUserId = getCookie('vk_user_id');

    if (!vkToken || !vkUserId) {
      document.getElementById('auth-hint').classList.remove('hidden');
      document.getElementById('auth-hint').textContent =
        '–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –û–°–û, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º.';
    }

    // ========== –¥–∞—Ç—ã (–ï–≤—Ä–æ–ø–∞/–¶—é—Ä–∏—Ö) ==========
    const tz = 'Europe/Zurich';
    const fmt = (d) => new Intl.DateTimeFormat('ru-RU', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' }).format(d);
    function ymdZurich(date){
      const parts = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(date)
        .reduce((a,p)=> (a[p.type]=p.value, a), {});
      return `${parts.year}-${parts.month}-${parts.day}`;
    }
    const now = new Date();
    const todayYMD = ymdZurich(now);
    const tomorrow = new Date(new Date(now).setDate(now.getDate()+1));
    const tomorrowYMD = ymdZurich(tomorrow);

    // ========== mood options ==========
    const MOODS = ['—Ä–∞–¥–æ—Å—Ç–Ω–æ–µ','–≥—Ä—É—Å—Ç–Ω–æ–µ','—Ç—Ä–µ–≤–æ–∂–Ω–æ–µ','—Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ–µ','–≤–∏–Ω–æ–≤–∞—Ç–æ–µ','—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ–µ','–≤–æ–∑–±—É–∂–¥–µ–Ω–Ω–æ–µ','—Å–∫—É—á–Ω–æ–µ','—Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ'];
    const moodsWrap = document.getElementById('moods');
    let pickedMood = null, pickedGender = null, pickedDate = null, generatedOutfit = null;

    MOODS.forEach(m => {
      const b = document.createElement('button');
      b.className = 'chip';
      b.textContent = m.charAt(0).toUpperCase() + m.slice(1);
      b.onclick = () => {
        [...moodsWrap.children].forEach(c=>c.classList.remove('active'));
        b.classList.add('active');
        pickedMood = m;
        maybeEnableGen();
      };
      moodsWrap.appendChild(b);
    });

    document.querySelectorAll('#genders .chip').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#genders .chip').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        pickedGender = btn.dataset.gender;
        maybeEnableGen();
      }
    });

    function maybeEnableGen(){
      const genBtn = document.getElementById('genBtn');
      if (pickedMood && pickedGender && pickedDate === tomorrowYMD) {
        genBtn.disabled = false;
        genBtn.classList.remove('disabled','opacity-50');
      } else {
        genBtn.disabled = true;
        genBtn.classList.add('disabled','opacity-50');
      }
    }

    // ========== —Ä–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è ==========
    const monthLabel = document.getElementById('monthLabel');
    const todayLabel = document.getElementById('todayLabel');
    const daysGrid = document.getElementById('daysGrid');
    const picker = document.getElementById('picker');

    const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));
    // –ü–µ—Ä–µ—Å—á—ë—Ç –≤ –¶—é—Ä–∏—Ö –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–¥–≤–∏–≥–∞ –Ω–µ–¥–µ–ª–∏
    const tmp = new Date(new Intl.DateTimeFormat('en-CA', { timeZone: tz }).format(start)+'T00:00:00Z');
    const month = tmp.getUTCMonth(), year = tmp.getUTCFullYear();

    monthLabel.textContent = new Intl.DateTimeFormat('ru-RU', { month:'long', year:'numeric', timeZone: tz }).format(now);
    todayLabel.textContent = `–°–µ–≥–æ–¥–Ω—è: ${fmt(now)}`;

    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ (–ü–Ω=1‚Ä¶–í—Å=7)
    const firstDay = new Date(Date.UTC(year, month, 1));
    const fd = new Date(new Intl.DateTimeFormat('en-CA', { timeZone: tz }).format(firstDay)+'T00:00:00Z');
    let w = fd.getUTCDay(); if (w === 0) w = 7;

    // –ö–æ–ª-–≤–æ –¥–Ω–µ–π
    const daysInMonth = new Date(year, month+1, 0).getDate();

    // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –¥–æ –ø–µ—Ä–≤–æ–≥–æ
    for (let i=1;i<w;i++){
      const cell = document.createElement('button');
      cell.className = 'grid-day rounded-xl bg-[#101010] border border-white/5 disabled';
      cell.disabled = true; cell.innerHTML = '&nbsp;';
      daysGrid.appendChild(cell);
    }

    // –ü–æ–¥—Ç—è–Ω—É—Ç—å —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–Ω–∏ –∏–∑ –ë–î
    let completed = {};
    try {
      const res = await fetch(`/api/calendar-get?year=${year}&month=${month+1}`, { credentials:'include' });
      if (res.ok) {
        const data = await res.json(); // { entries: [{date, outfit}] }
        data.entries.forEach(e => completed[e.date]=true);
      }
    } catch(e){}

    for (let d=1; d<=daysInMonth; d++){
      const date = new Date(Date.UTC(year, month, d));
      const ymd = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' })
                    .format(date);
      const isTomorrow = (ymd === tomorrowYMD);
      const isPastOrOther = (ymd !== tomorrowYMD);

      const btn = document.createElement('button');
      btn.className = 'grid-day rounded-xl border text-sm flex items-center justify-center relative ' +
                      (isTomorrow ? 'bg-[#1b1b1b] border-white/10' : 'bg-[#101010] border-white/5 disabled opacity-40');
      btn.disabled = !isTomorrow;

      btn.textContent = d;

      // –≥–∞–ª–æ—á–∫–∞, –µ—Å–ª–∏ —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
      if (completed[ymd]) {
        btn.insertAdjacentHTML('beforeend',
          '<span class="absolute top-1 right-1 text-xs">‚úì</span>');
        btn.disabled = true;
        btn.classList.add('opacity-40');
      }

      if (isTomorrow && !completed[ymd]) {
        btn.addEventListener('click', () => {
          pickedDate = ymd;
          picker.classList.remove('hidden');
          maybeEnableGen();
        });
      }

      daysGrid.appendChild(btn);
    }

    // ========== –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞ ==========
    const genBtn = document.getElementById('genBtn');
    const resultCard = document.getElementById('resultCard');
    const outfitTextEl = document.getElementById('outfitText');
    const confirmBtn = document.getElementById('confirmBtn');

    genBtn.addEventListener('click', async () => {
      genBtn.disabled = true;
      genBtn.textContent = '–ü–æ–¥–±–∏—Ä–∞—é...';
      try {
        const r = await fetch('/api/generate-outfit', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ date: pickedDate, mood: pickedMood, gender: pickedGender })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
        generatedOutfit = data.outfit;
        outfitTextEl.textContent = generatedOutfit;
        resultCard.classList.remove('hidden');
        resultCard.scrollIntoView({ behavior:'smooth' });
      } catch (e) {
        alert(e.message);
      } finally {
        genBtn.textContent = '–ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑';
        maybeEnableGen();
      }
    });

    // ========== –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å ==========
    confirmBtn.addEventListener('click', async () => {
      confirmBtn.disabled = true;
      confirmBtn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';
      try {
        const r = await fetch('/api/calendar-set', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ date: pickedDate, mood: pickedMood, gender: pickedGender, outfit: generatedOutfit })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        alert('–ì–æ—Ç–æ–≤–æ! –î–µ–Ω—å –æ—Ç–º–µ—á–µ–Ω.');
        location.reload();
      } catch (e) {
        alert(e.message);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = '–û–∫–µ–π';
      }
    });
  </script>
</body>
</html>
